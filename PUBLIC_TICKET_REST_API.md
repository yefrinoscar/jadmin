# Public Ticket Submission REST API

Este documento describe la API REST p√∫blica para el env√≠o de tickets desde sitios web externos.

## üåê Endpoint Principal

```
POST /api/public-tickets
```

Esta API permite a sitios web externos enviar tickets sin autenticaci√≥n previa, con nombres de empresas y service tags que pueden no existir en el sistema.

## üìã Caracter√≠sticas

- ‚úÖ **Sin autenticaci√≥n requerida** - Acceso p√∫blico total
- ‚úÖ **CORS habilitado** - Puede ser llamado desde cualquier dominio
- ‚úÖ **Validaci√≥n autom√°tica** - Usa Zod para validar datos
- ‚úÖ **Empresas flexibles** - Acepta nombres de empresa que no existen
- ‚úÖ **Service tags flexibles** - Crea tags autom√°ticamente si no existen
- ‚úÖ **Aprobaci√≥n admin** - Todos los tickets requieren aprobaci√≥n
- ‚úÖ **Respuestas est√°ndar** - JSON con estructura consistente

## üîß Uso desde Sitios Web Externos

### JavaScript/Fetch

```javascript
// Create form data
const formData = new FormData();
formData.append('title', 'Sistema de punto de venta no responde');
formData.append('description', 'El sistema POS se cuelga cuando intentamos procesar pagos con tarjeta. Necesitamos soluci√≥n urgente.');
formData.append('company_name', 'Restaurante El Buen Sabor');
formData.append('service_tag_names[]', 'POS-001');
formData.append('service_tag_names[]', 'TERMINAL-PRINCIPAL');
formData.append('contact_name', 'Mar√≠a Gonz√°lez');
formData.append('contact_email', 'maria.gonzalez@elbuensabor.com');
formData.append('contact_phone', '+1-234-567-8901');
formData.append('priority', 'high'); // opcional: low, medium, high
formData.append('source', 'web');    // opcional

// Opcional: Agregar fotos
if (photoFiles.length > 0) {
  photoFiles.forEach(file => {
    formData.append('photos', file);
  });
}

const response = await fetch('https://tu-dominio.com/api/public-tickets', {
  method: 'POST',
  body: formData // No necesitas especificar Content-Type, el navegador lo hace autom√°ticamente
});

const result = await response.json();

if (result.success) {
  console.log('Ticket creado:', result.data.ticket_id);
  console.log('Empresa:', result.data.company_name);
  console.log('¬øEmpresa nueva?:', result.data.client_was_new);
  console.log('Service tags:', result.data.service_tags.length);
  console.log(result.data.message);
} else {
  console.error('Error:', result.error);
  console.error('Mensaje:', result.message);
  if (result.details) {
    console.error('Detalles:', result.details);
  }
}
```

### jQuery

```javascript
// Create form data
const formData = new FormData();
formData.append('title', 'Problema con impresora');
formData.append('description', 'La impresora principal no est√° funcionando desde esta ma√±ana');
formData.append('company_name', 'Oficina Central');
formData.append('service_tag_names[]', 'PRINTER-001');
formData.append('contact_name', 'Juan P√©rez');
formData.append('contact_email', 'juan.perez@empresa.com');
formData.append('contact_phone', '+1-555-0123');

// Opcional: Agregar fotos
if ($('#photos')[0].files.length > 0) {
  Array.from($('#photos')[0].files).forEach(file => {
    formData.append('photos', file);
  });
}

$.ajax({
  url: 'https://tu-dominio.com/api/public-tickets',
  method: 'POST',
  processData: false, // Importante: no procesar los datos
  contentType: false, // Importante: dejar que jQuery establezca el boundary correcto
  data: formData,
  success: function(result) {
    if (result.success) {
      alert('Ticket enviado exitosamente. ID: ' + result.data.ticket_id);
    } else {
      alert('Error: ' + result.message);
    }
  },
  error: function(xhr, status, error) {
    alert('Error de conexi√≥n: ' + error);
  }
});
```

### Axios

```javascript
import axios from 'axios';

// Create form data
const formData = new FormData();
formData.append('title', 'Red lenta en sucursal');
formData.append('description', 'La conexi√≥n a internet est√° muy lenta, afectando las operaciones');
formData.append('company_name', 'Sucursal Norte');
formData.append('service_tag_names[]', 'NETWORK-001');
formData.append('service_tag_names[]', 'ROUTER-PRINCIPAL');
formData.append('contact_name', 'Ana L√≥pez');
formData.append('contact_email', 'ana.lopez@sucursal.com');
formData.append('contact_phone', '+1-555-9876');

// Opcional: Agregar fotos
if (photoFiles.length > 0) {
  photoFiles.forEach(file => {
    formData.append('photos', file);
  });
}

try {
  const response = await axios.post('https://tu-dominio.com/api/public-tickets', formData, {
    headers: {
      'Content-Type': 'multipart/form-data' // Opcional: Axios lo detecta autom√°ticamente
    }
  });

  if (response.data.success) {
    console.log('Ticket enviado:', response.data.data);
  }
} catch (error) {
  console.error('Error:', error.response?.data || error.message);
}
```

## üìä Estructura de Datos

### Request Body (Obligatorio)

```typescript
{
  title: string;           // T√≠tulo del ticket
  description: string;     // Descripci√≥n detallada
  company_name: string;    // Nombre de la empresa (se crea si no existe)
  service_tag_names: string[]; // Array de service tags (se crean si no existen)
  contact_name: string;    // Nombre del contacto
  contact_email: string;   // Email del contacto
  contact_phone: string;   // Tel√©fono del contacto
  priority?: 'low' | 'medium' | 'high'; // Opcional, default: 'medium'
  source?: string;         // Opcional, default: 'web'
  photo_url?: string;      // Opcional, URL de foto adjunta
}
```

### Response - √âxito (201)

```json
{
  "success": true,
  "data": {
    "ticket_id": "12345",
    "company_name": "Restaurante El Buen Sabor",
    "client_was_new": true,
    "service_tags": [
      {
        "tag": "POS-001",
        "status": "created"
      },
      {
        "tag": "TERMINAL-PRINCIPAL", 
        "status": "existing"
      }
    ],
    "message": "Ticket created successfully and is pending admin approval"
  }
}
```

### Response - Error de Validaci√≥n (400)

```json
{
  "success": false,
  "error": "Validation failed",
  "message": "Please check the submitted data and try again.",
  "details": [
    {
      "code": "invalid_type",
      "expected": "string",
      "received": "undefined",
      "path": ["title"],
      "message": "Required"
    }
  ]
}
```

### Response - Error del Servidor (500)

```json
{
  "success": false,
  "error": "Database error",
  "message": "Failed to create ticket. Please try again later.",
  "details": "Error details (only in development)"
}
```

## üîí Seguridad y CORS

### Headers CORS Incluidos

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Max-Age: 86400
```

### Recomendaciones de Producci√≥n

1. **Restringir dominios**: Cambiar `Access-Control-Allow-Origin: *` por dominios espec√≠ficos
2. **Rate limiting**: Implementar l√≠mites de velocidad por IP
3. **Validaci√≥n adicional**: Agregar validaci√≥n de honeypot para spam
4. **Logging**: Monitorear intentos de env√≠o

## ‚ö° C√≥digos de Estado HTTP

| C√≥digo | Descripci√≥n |
|--------|-------------|
| 200    | Preflight OPTIONS exitoso |
| 201    | Ticket creado exitosamente |
| 400    | Error de validaci√≥n |
| 405    | M√©todo no permitido (solo POST) |
| 500    | Error interno del servidor |

## üß™ Testing

### Comando cURL

```bash
# Sin fotos
curl -X POST http://localhost:3000/api/public-tickets \
  -F "title=Test ticket via REST API" \
  -F "description=Testing the REST API endpoint" \
  -F "company_name=Test Company" \
  -F "service_tag_names[]=TEST-001" \
  -F "service_tag_names[]=API-TEST" \
  -F "contact_name=Test User" \
  -F "contact_email=test@test.com" \
  -F "contact_phone=+1-555-0123"

# Con fotos
curl -X POST http://localhost:3000/api/public-tickets \
  -F "title=Test ticket via REST API" \
  -F "description=Testing the REST API endpoint" \
  -F "company_name=Test Company" \
  -F "service_tag_names[]=TEST-001" \
  -F "service_tag_names[]=API-TEST" \
  -F "contact_name=Test User" \
  -F "contact_email=test@test.com" \
  -F "contact_phone=+1-555-0123" \
  -F "photos=@/path/to/photo1.jpg" \
  -F "photos=@/path/to/photo2.jpg"
```

### Respuesta de Prueba

```bash
# Success Response
{"success":true,"data":{"ticket_id":"12345","company_name":"Test Company","client_was_new":true,"service_tags":[{"tag":"TEST-001","status":"created"}],"message":"Ticket created successfully and is pending admin approval"}}

# Error Response (if migrations not applied)
{"success":false,"error":"relation \"ticket_id_seq\" does not exist","message":"Failed to create ticket: relation \"ticket_id_seq\" does not exist"}
```

## üìã Estados del Proceso

### 1. ‚úÖ Implementaci√≥n Completada
- [x] Endpoint REST `/api/public-tickets`
- [x] Validaci√≥n con Zod
- [x] CORS configurado
- [x] Manejo de errores
- [x] Respuestas estandarizadas
- [x] Soporte para m√©todos OPTIONS
- [x] Documentaci√≥n completa

### 2. ‚è≥ Requiere Configuraci√≥n
- [ ] Aplicar migraci√≥n `008_public_ticket_submission.sql` en Supabase
- [ ] Configurar variables de entorno de producci√≥n
- [ ] Establecer dominios CORS espec√≠ficos

### 3. üöÄ Pr√≥ximos Pasos
- [ ] Interfaz de administraci√≥n para aprobar tickets
- [ ] Rate limiting por IP
- [ ] Notificaciones por email
- [ ] Dashboard de m√©tricas

## üîß Configuraci√≥n Requerida

### Variables de Entorno

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

### Migraci√≥n de Base de Datos

Aplicar el archivo de migraci√≥n:
```sql
-- File: supabase/migrations/008_public_ticket_submission.sql
-- Contiene las funciones create_public_ticket, get_pending_approval_tickets, approve_public_ticket
```

## üìû Soporte

Para cualquier pregunta sobre la integraci√≥n de esta API:

1. Revisar los c√≥digos de error en la respuesta
2. Verificar que todos los campos obligatorios est√©n presentes
3. Confirmar que la migraci√≥n de base de datos est√© aplicada
4. Revisar los logs del servidor para errores espec√≠ficos

## üéØ Ejemplo de Integraci√≥n Completa

```html
<!DOCTYPE html>
<html>
<head>
    <title>Formulario de Soporte</title>
</head>
<body>
    <form id="support-form">
        <input type="text" id="title" placeholder="T√≠tulo del problema" required>
        <textarea id="description" placeholder="Describe el problema" required></textarea>
        <input type="text" id="company" placeholder="Nombre de la empresa" required>
        <input type="text" id="tags" placeholder="Service tags (separados por coma)" required>
        <input type="text" id="contact_name" placeholder="Tu nombre" required>
        <input type="email" id="contact_email" placeholder="Tu email" required>
        <input type="tel" id="contact_phone" placeholder="Tu tel√©fono" required>
        <select id="priority">
            <option value="low">Baja</option>
            <option value="medium" selected>Media</option>
            <option value="high">Alta</option>
        </select>
        <button type="submit">Enviar Ticket</button>
    </form>

    <script>
        document.getElementById('support-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                company_name: document.getElementById('company').value,
                service_tag_names: document.getElementById('tags').value.split(',').map(s => s.trim()),
                contact_name: document.getElementById('contact_name').value,
                contact_email: document.getElementById('contact_email').value,
                contact_phone: document.getElementById('contact_phone').value,
                priority: document.getElementById('priority').value,
                source: 'web'
            };

            try {
                const response = await fetch('https://tu-dominio.com/api/public-tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Ticket enviado exitosamente!\nID: ${result.data.ticket_id}\nEl ticket est√° pendiente de aprobaci√≥n por un administrador.`);
                    document.getElementById('support-form').reset();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Error de conexi√≥n: ${error.message}`);
            }
        });
    </script>
</body>
</html>
```

---

**Nota**: Esta API est√° lista para uso en producci√≥n una vez aplicada la migraci√≥n de base de datos correspondiente. 